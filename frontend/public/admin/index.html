<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Brainiax Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/admin/admin.css">
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- The rest of this file mirrors backend/admin.html functionality -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
      <div class="text-center mb-8">
        <div class="w-16 h-16 bg-gray-900 rounded-xl flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-shield-alt text-white text-2xl"></i>
        </div>
        <h1 class="text-2xl font-bold text-gray-900">Admin Dashboard</h1>
        <p class="text-gray-600 mt-2">Enter your admin token to continue</p>
        <p class="text-xs text-gray-400 mt-1" id="apiUrlDisplay"></p>
      </div>
      <form onsubmit="handleLogin(event)">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
          <input type="text" id="username" required
                 class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                 placeholder="Enter your username">
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
          <input type="password" id="password" required
                 class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                 placeholder="Enter your password">
        </div>
        <div class="mb-4 hidden">
          <input type="text" id="apiUrl" value="">
        </div>
        <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
          <i class="fas fa-sign-in-alt mr-2"></i> Login
        </button>
        <p id="loginError" class="text-red-500 text-xs mt-3 text-left hidden whitespace-pre-line"></p>
      </form>
    </div>
  </div>

  <div id="dashboard" class="hidden">
    <header class="bg-white shadow-sm border-b">
      <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-gray-900 rounded-lg flex items-center justify-center">
            <i class="fas fa-chart-line text-white"></i>
          </div>
          <h1 class="text-xl font-bold text-gray-900">Brainiax Admin</h1>
        </div>
        <div class="flex items-center gap-4">
          <span class="text-xs text-gray-500" id="connectionStatus">Connected to: <span id="currentApiUrl"></span></span>
          <button onclick="logout()" class="text-gray-600 hover:text-gray-900 flex items-center gap-2">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </div>
      </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 py-6">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-xl p-6 shadow-sm border">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 text-sm">Active Jobs</p>
              <p id="statActiveJobs" class="text-3xl font-bold text-gray-900">-</p>
            </div>
            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
              <i class="fas fa-briefcase text-blue-600"></i>
            </div>
          </div>
        </div>
        <div class="bg-white rounded-xl p-6 shadow-sm border">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 text-sm">Applications</p>
              <p id="statResumes" class="text-3xl font-bold text-gray-900">-</p>
            </div>
            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
              <i class="fas fa-file-alt text-green-600"></i>
            </div>
          </div>
        </div>
        <div class="bg-white rounded-xl p-6 shadow-sm border">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 text-sm">Contacts</p>
              <p id="statContacts" class="text-3xl font-bold text-gray-900">-</p>
            </div>
            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
              <i class="fas fa-envelope text-purple-600"></i>
            </div>
          </div>
        </div>
        <div class="bg-white rounded-xl p-6 shadow-sm border">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 text-sm">New Inquiries</p>
              <p id="statNewContacts" class="text-3xl font-bold text-red-600">-</p>
            </div>
            <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
              <i class="fas fa-bell text-red-600"></i>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
        <div class="border-b flex">
          <button onclick="showTab('jobs')" id="tabJobs" class="px-6 py-4 font-semibold text-gray-600 hover:text-blue-600 tab-active">
            <i class="fas fa-briefcase mr-2"></i> Jobs
          </button>
          <button onclick="showTab('applications')" id="tabApplications" class="px-6 py-4 font-semibold text-gray-600 hover:text-blue-600">
            <i class="fas fa-file-alt mr-2"></i> Applications
          </button>
          <button onclick="showTab('contacts')" id="tabContacts" class="px-6 py-4 font-semibold text-gray-600 hover:text-blue-600">
            <i class="fas fa-envelope mr-2"></i> Contacts
          </button>
        </div>

        <div id="panelJobs" class="p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-bold">Job Listings</h2>
            <button onclick="openJobModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700">
              <i class="fas fa-plus mr-2"></i> Add Job
            </button>
          </div>
          <div id="jobsList" class="space-y-3">
            <p class="text-gray-500">Loading...</p>
          </div>
        </div>

        <div id="panelApplications" class="p-6 hidden">
          <h2 class="text-lg font-bold mb-4">Job Applications</h2>
          <div id="applicationsList" class="space-y-3">
            <p class="text-gray-500">Loading...</p>
          </div>
        </div>

        <div id="panelContacts" class="p-6 hidden">
          <h2 class="text-lg font-bold mb-4">Contact Submissions</h2>
          <div id="contactsList" class="space-y-3">
            <p class="text-gray-500">Loading...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="jobModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b flex items-center justify-between">
        <h3 id="jobModalTitle" class="text-xl font-bold">Add New Job</h3>
        <button onclick="closeJobModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <form onsubmit="saveJob(event)" class="p-6 space-y-4">
        <input type="hidden" id="jobId">
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Job Title *</label>
            <input type="text" id="jobTitle" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Department</label>
            <input type="text" id="jobDepartment" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
        </div>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
            <input type="text" id="jobLocation" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Job Type</label>
            <select id="jobType" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
              <option value="Full-time">Full-time</option>
              <option value="Part-time">Part-time</option>
              <option value="Contract">Contract</option>
              <option value="Remote">Remote</option>
            </select>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Salary Range</label>
          <input type="text" id="jobSalary" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g. $50,000 - $70,000">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
          <textarea id="jobDescription" rows="3" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Requirements (one per line)</label>
          <textarea id="jobRequirements" rows="4" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Excellent communication skills&#10;2+ years experience&#10;..."></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Benefits (one per line)</label>
          <textarea id="jobBenefits" rows="3" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Health insurance&#10;Paid time off&#10;..."></textarea>
        </div>
        <div class="flex items-center gap-2">
          <input type="checkbox" id="jobIsActive" checked class="w-4 h-4 text-blue-600 rounded">
          <label for="jobIsActive" class="text-sm text-gray-700">Active (visible on website)</label>
        </div>
        <div class="flex gap-3 pt-4">
          <button type="submit" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700">
            <i class="fas fa-save mr-2"></i> Save Job
          </button>
          <button type="button" onclick="closeJobModal()" class="px-6 py-3 border border-gray-300 rounded-lg font-semibold hover:bg-gray-50">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <div id="detailModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b flex items-center justify-between">
        <h3 id="detailModalTitle" class="text-xl font-bold">Details</h3>
        <button onclick="closeDetailModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div id="detailModalContent" class="p-6"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  <script>
    let API_URL = '';
    let JWT_TOKEN = '';

    // Auto-configure API URL
    function setupApiUrl() {
      // Try to get from environment variable first (set in Vercel)
      const envApiUrl = '__VITE_API_BASE_URL__'; // Will be replaced at build time
      
      if (envApiUrl && envApiUrl !== '__VITE_API_BASE_URL__') {
        API_URL = envApiUrl;
      } else if (localStorage.getItem('apiUrl')) {
        // Use previously saved URL
        API_URL = localStorage.getItem('apiUrl');
      } else {
        // Production fallback - your actual Render backend URL
        API_URL = 'https://brainiax-website.onrender.com';
      }
      
      // Remove trailing slash
      API_URL = API_URL.replace(/\/$/, '');
      
      // Set the hidden field
      document.getElementById('apiUrl').value = API_URL;
      
      // Display API URL to user
      const displayEl = document.getElementById('apiUrlDisplay');
      if (displayEl) {
        displayEl.textContent = `Backend: ${API_URL}`;
      }
      
      console.log('Using API URL:', API_URL);
    }

    async function handleLogin(e) {
      e.preventDefault();
      
      // Auto-configure API URL
      setupApiUrl();
      
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      try {
        // Login with username/password to get JWT token
        const loginRes = await fetch(`${API_URL}/api/admin/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        
        if (!loginRes.ok) {
          const errorData = await loginRes.json().catch(() => ({ message: 'Login failed' }));
          throw new Error(errorData.message || 'Invalid credentials');
        }

        const { token } = await loginRes.json();
        JWT_TOKEN = token;

        // Test the token by fetching stats
        const statsRes = await fetch(`${API_URL}/api/admin/stats`, {
          headers: { 'Authorization': `Bearer ${JWT_TOKEN}` }
        });
        
        if (!statsRes.ok) throw new Error('Authentication failed');

        // Store credentials
        localStorage.setItem('jwtToken', JWT_TOKEN);
        localStorage.setItem('apiUrl', API_URL);

        // Hide login, show dashboard
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
        
        // Display API URL in header
        document.getElementById('currentApiUrl').textContent = API_URL;
        
        loadDashboard();
        setupRealtime();
      } catch (err) {
        console.error('Login error:', err);
        console.error('API URL used:', API_URL);
        let errorMsg = err.message || 'Login failed';
        if (err.message === 'Failed to fetch') {
          errorMsg = `Cannot connect to backend at ${API_URL}. Please check:\n1. Backend is deployed and running\n2. Backend URL is correct\n3. CORS is configured`;
        }
        document.getElementById('loginError').textContent = errorMsg;
        document.getElementById('loginError').classList.remove('hidden');
      }
    }

    function logout() {
      localStorage.removeItem('jwtToken');
      localStorage.removeItem('apiUrl');
      JWT_TOKEN = null;
      location.reload();
    }

    window.onload = function() {
      setupApiUrl();
      
      const savedToken = localStorage.getItem('jwtToken');
      const savedUrl = localStorage.getItem('apiUrl');
      if (savedToken && savedUrl) {
        JWT_TOKEN = savedToken;
        API_URL = savedUrl;
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
        
        // Display API URL in header
        document.getElementById('currentApiUrl').textContent = API_URL;
        
        loadDashboard();
        setupRealtime();
      }
    };

    async function api(endpoint, method = 'GET', body = null) {
      const opts = {
        method,
        headers: { 
          'Authorization': `Bearer ${JWT_TOKEN}`,
          'Content-Type': 'application/json' 
        }
      };
      if (body) opts.body = JSON.stringify(body);
      
      try {
        const res = await fetch(`${API_URL}${endpoint}`, opts);
        if (!res.ok) {
          if (res.status === 401) {
            // Token expired or invalid, logout
            logout();
            throw new Error('Authentication expired');
          }
          const errorText = await res.text().catch(() => 'Unknown error');
          console.error(`API Error ${res.status}:`, errorText);
          throw new Error(`HTTP ${res.status}: ${errorText}`);
        }
        return res.json();
      } catch (error) {
        console.error('API Request Failed:', {
          endpoint,
          method,
          apiUrl: API_URL,
          error: error.message
        });
        
        // Show user-friendly error
        if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
          alert(`Cannot connect to backend at ${API_URL}\n\nPlease check:\n1. Backend is running\n2. CORS is configured\n3. Network connection`);
        }
        throw error;
      }
    }

    async function loadDashboard() {
      try {
        console.log('Loading dashboard from:', API_URL);
        const stats = await api('/api/admin/stats');
        document.getElementById('statActiveJobs').textContent = stats.activeJobs;
        document.getElementById('statResumes').textContent = stats.totalResumes;
        document.getElementById('statContacts').textContent = stats.totalContacts;
        document.getElementById('statNewContacts').textContent = stats.newContacts;

        loadJobs();
        loadApplications();
        loadContacts();
      } catch (err) {
        console.error('Dashboard load error:', err);
        alert('Failed to load dashboard. Check console for details.');
      }
    }

    function showTab(tab) {
      ['Jobs', 'Applications', 'Contacts'].forEach(t => {
        document.getElementById(`tab${t}`).classList.remove('tab-active');
        document.getElementById(`panel${t}`).classList.add('hidden');
      });
      document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('tab-active');
      document.getElementById(`panel${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.remove('hidden');
    }

    async function loadJobs() {
      try {
        const jobs = await api('/api/admin/jobs');
        const container = document.getElementById('jobsList');
        if (jobs.length === 0) {
          container.innerHTML = '<p class="text-gray-500">No jobs posted yet.</p>';
          return;
        }
        container.innerHTML = jobs.map(job => `
          <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border ${!job.isActive ? 'opacity-60' : ''}">
            <div>
              <h4 class="font-semibold text-gray-900">${job.title}</h4>
              <p class="text-sm text-gray-500">${job.department || ''} • ${job.location || ''} • ${job.type || ''}</p>
              <p class="text-xs text-gray-400 mt-1">${job.applicationsCount || 0} applications</p>
            </div>
            <div class="flex items-center gap-2">
              <span class="px-2 py-1 text-xs rounded-full ${job.isActive ? 'bg-green-100 text-green-700' : 'bg-gray-200 text-gray-600'}">
                ${job.isActive ? 'Active' : 'Inactive'}
              </span>
              <button onclick="editJob('${job._id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded">
                <i class="fas fa-edit"></i>
              </button>
              <button onclick="deleteJob('${job._id}')" class="p-2 text-red-600 hover:bg-red-50 rounded">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `).join('');
      } catch (err) {
        console.error('Jobs load error:', err);
      }
    }

    function openJobModal(job = null) {
      document.getElementById('jobModalTitle').textContent = job ? 'Edit Job' : 'Add New Job';
      document.getElementById('jobId').value = job?._id || '';
      document.getElementById('jobTitle').value = job?.title || '';
      document.getElementById('jobDepartment').value = job?.department || '';
      document.getElementById('jobLocation').value = job?.location || '';
      document.getElementById('jobType').value = job?.type || 'Full-time';
      document.getElementById('jobSalary').value = job?.salary || '';
      document.getElementById('jobDescription').value = job?.description || '';
      document.getElementById('jobRequirements').value = (job?.requirements || []).join('\n');
      document.getElementById('jobBenefits').value = (job?.benefits || []).join('\n');
      document.getElementById('jobIsActive').checked = job?.isActive !== false;
      document.getElementById('jobModal').classList.add('active');
    }

    function closeJobModal() {
      document.getElementById('jobModal').classList.remove('active');
    }

    async function editJob(id) {
      try {
        const job = await api(`/api/jobs/${id}`);
        openJobModal(job);
      } catch (err) {
        console.error('Edit job error:', err);
        alert('Failed to load job: ' + (err.message || err));
      }
    }

    async function saveJob(e) {
      e.preventDefault();
      const id = document.getElementById('jobId').value;
      const data = {
        title: document.getElementById('jobTitle').value,
        department: document.getElementById('jobDepartment').value,
        location: document.getElementById('jobLocation').value,
        type: document.getElementById('jobType').value,
        salary: document.getElementById('jobSalary').value,
        description: document.getElementById('jobDescription').value,
        requirements: document.getElementById('jobRequirements').value.split('\n').filter(r => r.trim()),
        benefits: document.getElementById('jobBenefits').value.split('\n').filter(b => b.trim()),
        isActive: document.getElementById('jobIsActive').checked
      };
      try {
        if (id) {
          await api(`/api/jobs/${id}`, 'PUT', data);
        } else {
          await api('/api/jobs', 'POST', data);
        }
        closeJobModal();
        loadJobs();
        loadDashboard();
      } catch (err) {
        alert('Failed to save job: ' + err.message);
      }
    }

    async function deleteJob(id) {
      if (!confirm('Are you sure you want to delete this job?')) return;
      try {
        await api(`/api/jobs/${id}`, 'DELETE');
        loadJobs();
        loadDashboard();
      } catch (err) {
        console.error('Delete job error:', err);
        alert('Failed to delete job: ' + (err.message || err));
      }
    }

    async function loadApplications() {
      try {
        const data = await api('/api/admin/resumes?limit=50');
        const container = document.getElementById('applicationsList');
        if (data.items.length === 0) {
          container.innerHTML = '<p class="text-gray-500">No applications yet.</p>';
          return;
        }
        container.innerHTML = data.items.map(app => `
          <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border">
            <div>
              <h4 class="font-semibold text-gray-900">${app.name}</h4>
              <p class="text-sm text-gray-500">${app.email} • ${app.phone || "No phone"}</p>
              <p class="text-sm text-blue-600">${app.position || "General Application"}</p>
              <p class="text-xs text-gray-400 mt-1">${new Date(app.createdAt).toLocaleString()}</p>
            </div>
            <div class="flex items-center gap-2">
              <a href="${API_URL}${app.resumeUrl}" target="_blank" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">
                <i class="fas fa-download mr-1"></i> Resume
              </a>
              <a href="mailto:${app.email}" class="p-2 text-green-600 hover:bg-green-50 rounded">
                <i class="fas fa-envelope"></i>
              </a>
              <button onclick="deleteApplication('${app._id}')" class="p-2 text-red-600 hover:bg-red-50 rounded">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `).join('');
      } catch (err) {
        console.error('Applications load error:', err);
      }
    }

    async function deleteApplication(id) {
      if (!confirm('Are you sure you want to delete this application?')) return;
      try {
        await api(`/api/admin/resumes/${id}`, 'DELETE');
        loadApplications();
        loadDashboard();
      } catch (err) {
        alert('Failed to delete application');
      }
    }

    async function loadContacts() {
      try {
        const data = await api('/api/admin/contacts?limit=50');
        const container = document.getElementById('contactsList');
        if (data.items.length === 0) {
          container.innerHTML = '<p class="text-gray-500">No contact submissions yet.</p>';
          return;
        }
        container.innerHTML = data.items.map(c => `
          <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border">
            <div class="flex-1">
              <div class="flex items-center gap-2">
                <h4 class="font-semibold text-gray-900">${c.name}</h4>
                <span class="px-2 py-0.5 text-xs rounded-full ${c.status === "new" ? "bg-red-100 text-red-700" : c.status === "contacted" ? "bg-yellow-100 text-yellow-700" : "bg-green-100 text-green-700"}">${c.status}</span>
              </div>
              <p class="text-sm text-gray-500">${c.email} • ${c.phone || "No phone"}</p>
              ${c.company ? `<p class="text-sm text-gray-600">${c.company}</p>` : ""}
              ${c.message ? `<p class="text-sm text-gray-700 mt-2 line-clamp-2">${c.message}</p>` : ""}
              <p class="text-xs text-gray-400 mt-1">${new Date(c.createdAt).toLocaleString()}</p>
            </div>
            <div class="flex items-center gap-2 ml-4">
              <select onchange="updateContactStatus('${c._id}', this.value)" class="text-sm border rounded px-2 py-1">
                <option value="new" ${c.status === "new" ? "selected" : ""}>New</option>
                <option value="contacted" ${c.status === "contacted" ? "selected" : ""}>Contacted</option>
                <option value="resolved" ${c.status === "resolved" ? "selected" : ""}>Resolved</option>
              </select>
              <a href="mailto:${c.email}" class="p-2 text-green-600 hover:bg-green-50 rounded">
                <i class="fas fa-envelope"></i>
              </a>
              ${c.phone ? `<a href="tel:${c.phone}" class="p-2 text-blue-600 hover:bg-blue-50 rounded"><i class="fas fa-phone"></i></a>` : ""}
              <button onclick="deleteContact('${c._id}')" class="p-2 text-red-600 hover:bg-red-50 rounded">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `).join('');
      } catch (err) {
        console.error('Contacts load error:', err);
      }
    }

    async function updateContactStatus(id, status) {
      try {
        await api(`/api/admin/contacts/${id}`, 'PUT', { status });
        loadContacts();
        loadDashboard();
      } catch (err) {
        alert('Failed to update status');
      }
    }

    async function deleteContact(id) {
      if (!confirm('Are you sure you want to delete this contact?')) return;
      try {
        await api(`/api/admin/contacts/${id}`, 'DELETE');
        loadContacts();
        loadDashboard();
      } catch (err) {
        alert('Failed to delete contact');
      }
    }

    function closeDetailModal() {
      document.getElementById('detailModal').classList.remove('active');
    }

    let sse;
    let poller;
    function setupRealtime() {
      if (sse) { try { sse.close(); } catch (e) {} }
      if (poller) { clearInterval(poller); }
      try {
        const url = `${API_URL}/api/admin/events?adminToken=${encodeURIComponent(JWT_TOKEN)}`;
        sse = new EventSource(url);
        sse.onopen = () => { if (poller) { clearInterval(poller); poller = null; } };
        sse.onerror = () => { if (!poller) startPolling(); };
        sse.addEventListener('job-change', () => { loadJobs(); loadDashboard(); });
        sse.addEventListener('resume-change', () => { loadApplications(); loadDashboard(); });
        sse.addEventListener('contact-change', () => { loadContacts(); loadDashboard(); });
      } catch (e) { startPolling(); }
      function startPolling() {
        if (poller) return;
        poller = setInterval(() => {
          loadJobs();
          loadApplications();
          loadContacts();
          api('/api/admin/stats').then(stats => {
            document.getElementById('statActiveJobs').textContent = stats.activeJobs;
            document.getElementById('statResumes').textContent = stats.totalResumes;
            document.getElementById('statContacts').textContent = stats.totalContacts;
            document.getElementById('statNewContacts').textContent = stats.newContacts;
          }).catch(()=>{});
        }, 15000);
      }
    }
  </script>
</body>
</html>
